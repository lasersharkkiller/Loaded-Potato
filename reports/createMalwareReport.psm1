function New-MalwareDashboard {
    param (
        [string]$RootPath = ".\apt\c6g",
        [string]$OutputHtmlPath = ".\output\Global_Threat_Dashboard.html",
        [string]$ReportTitle = "NextGen Threat Intel Dashboard"
    )

    Write-Host "Generating Dashboard (v63.1 - v12.3 Sync)..." -ForegroundColor Cyan
    
    if (-not (Test-Path $RootPath)) { Write-Error "Root path not found: $RootPath"; return }
    $AbsRoot = (Resolve-Path $RootPath).Path
    $AbsOutput = [System.IO.Path]::GetFullPath($OutputHtmlPath)
    $OutputDir = Split-Path $AbsOutput -Parent
    if (-not (Test-Path $OutputDir)) { New-Item -ItemType Directory -Path $OutputDir -Force | Out-Null }

    # --- 1. CONFIGURATION MAP (Strictly synced to v12.3 Harvester) ---
    $AptToolMap = @{
        # === CHINA ===
        "Velvet Ant"      = @("VelvetSting", "VelvetTap", "PlugX", "Impacket") 
        "Flax Typhoon"    = @("Metasploit")
        "UAT-8837"        = @("GoTokenTheft", "DWAgent", "SharpHound", "Impacket", "GoExec", "Rubeus", "Certipy")
        "Salt Typhoon"    = @("ShadowPad")
        "Storm-2603"      = @("Impacket")
        "Earth Krahang"   = @("RESHELL", "XDealer", "Cobalt Strike", "Fscan")
        "UAT-7290"        = @("RushDrop", "SilentRaid", "ShadowPad")
        "UNC3886"         = @("TinyShell", "Medusa")
        "Volt Typhoon"    = @("KV-Botnet", "Impacket", "EarthWorm")
        "APT1"            = @("PlugX")
        "APT10"           = @("PlugX", "QuasarRAT", "Chisel")
        "APT27"           = @("PlugX", "Fscan")
        "APT31"           = @()
        "APT41"           = @("ShadowPad", "Cobalt Strike", "Winnti")
        "Aquatic Panda"   = @("ShadowPad", "Winnti")
        "BlackTech"       = @("Kivars")
        "Gallium"         = @()
        "Hafnium"         = @()
        "Ke3chang"        = @("Okrum")
        "Mustang Panda"   = @("PlugX", "Cobalt Strike", "PDFSider")

        # === IRAN ===
        "MuddyWater"      = @("Ligolo", "Chisel")
        
        # === NORTH KOREA ===
        "Lazarus"         = @("Mimikatz")
        "Konni Group"     = @("Konni RAT", "Amadey") # ADDED
        "APT37"           = @("Konni RAT") # ADDED Link
        
        # === RUSSIA ===
        "APT28"           = @("Mimikatz", "Impacket", "Chisel")
        "Sandworm"        = @("DynoWiper", "Chisel")
        
        # === VIETNAM ===
        "APT32"           = @("Cobalt Strike")

        # === E-CRIME ===
        "ShinyHunters"    = @("ShinySp1d3r", "Impacket", "AsyncRAT", "ConnectWise ScreenConnect", "Malicious Data Loader")
        "LAPSUS$"         = @("Mimikatz")
        "RansomHub"       = @("Cobalt Strike", "Mimikatz", "Chisel", "AnyDesk")
        "Play Ransomware" = @("Cobalt Strike", "SystemBC")
        "Scattered Spider"= @("BlackCat", "Rubeus", "Mimikatz", "Rhadamanthys")
        "Wizard Spider"   = @("TrickBot")
        "TeamTNT"         = @("TeamTNT Tools")
        "Inc Ransom"      = @("Osiris Ransomware") # ADDED Link based on recent intel
    }

    # Relative Path Helper
    function Get-RelativePath {
        param ($From, $To)
        $FromPath = $From -replace "\\", "/"
        $ToPath   = $To   -replace "\\", "/"
        $FromParts = $FromPath -split "/"
        $ToParts   = $ToPath   -split "/"
        $i = 0
        while ($i -lt $FromParts.Count -and $i -lt $ToParts.Count -and $FromParts[$i] -eq $ToParts[$i]) { $i++ }
        $Back = "../" * ($FromParts.Count - $i - 1)
        $Fwd = ($ToParts[$i..($ToParts.Count-1)] -join "/")
        return "$Back$Fwd"
    }

    # --- 2. SUB-REPORT GENERATOR ---
    function Generate-SubReport {
        param (
            [string]$TargetFolder, 
            [string]$Title, 
            [string]$Breadcrumb, 
            [string]$ActorName, 
            [bool]$IsAPT
        )
        
        $ReportPath = Join-Path $TargetFolder "Detailed_Report.html"
        
        $Categories = [ordered]@{ 
            "Sigma Rules"            = "TargetedSigmaDifferentialAnalysis.json"
            "Yara Rules"             = "TargetedYaraDifferentialAnalysis.json"
            "IDS Rules"              = "TargetedIDSDifferentialAnalysis.json"
            "Windows API"            = "TargetedAPIDifferentialAnalysis.json"
            "Memory Pattern URLs"    = "TargetedMemoryPatternDifferentialAnalysis.json"
            "Memory Pattern Domains" = "TargetedMemoryDomainDifferentialAnalysis.json"
            "MITRE ATT&CK"           = "TargetedMitreDifferentialAnalysis.json"
            "VT Tags"                = "TargetedTagsDifferentialAnalysis.json"
            "Mutexes"                = "TargetedMutexDifferentialAnalysis.json"
            "Registry"               = "TargetedRegistryDifferentialAnalysis.json"
            "Processes"              = "TargetedProcessDifferentialAnalysis.json"
            "Certificates"           = "TargetedCertificateDifferentialAnalysis.json"
            "ELF Symbols"            = "TargetedElfDifferentialAnalysis.json"
        }

        $LocalData = [ordered]@{}
        $TotalItems = 0
        $GlobalMaxDate = "1970-01-01"

        $FoldersToScan = @(@{ Path=$TargetFolder; Label="Direct Observation" })

        if ($IsAPT -and $AptToolMap.ContainsKey($ActorName)) {
            $MalwareRoot = Join-Path $AbsRoot "Malware Families"
            foreach ($ToolName in $AptToolMap[$ActorName]) {
                $ToolPath = Join-Path $MalwareRoot $ToolName
                if (Test-Path $ToolPath) {
                    $FoldersToScan += @{ Path=$ToolPath; Label="Tool: $ToolName" }
                }
            }
        }

        foreach ($cat in $Categories.Keys) {
            $LocalData[$cat] = @() 
            foreach ($Source in $FoldersToScan) {
                $jPath = Join-Path $Source.Path $Categories[$cat]
                if (Test-Path $jPath) {
                    try {
                        $content = Get-Content $jPath -Raw | ConvertFrom-Json
                        if ($content) {
                            $arr = @($content)
                            foreach ($row in $arr) {
                                $row | Add-Member -MemberType NoteProperty -Name "_Source" -Value $Source.Label -Force
                                # Date Tracking
                                $rDate = "1970-01-01"
                                if ($row.PSObject.Properties.Match("Last_Seen").Count -gt 0 -and $row.Last_Seen) {
                                    $rDate = $row.Last_Seen
                                }
                                if ($rDate -gt $GlobalMaxDate) { $GlobalMaxDate = $rDate }
                            }
                            $LocalData[$cat] += $arr
                            $TotalItems += $arr.Count
                        }
                    } catch {}
                }
            }
        }

        if ($GlobalMaxDate -eq "1970-01-01") { $GlobalMaxDate = "Unknown" }

        # ENCODE DATA
        $JsonPayload = $LocalData | ConvertTo-Json -Depth 10 -Compress
        $Bytes = [System.Text.Encoding]::UTF8.GetBytes($JsonPayload)
        $B64Data = [Convert]::ToBase64String($Bytes)
        
        $BackLink = Get-RelativePath -From $ReportPath -To $AbsOutput

        # GENERATE SUB-REPORT HTML (Safe Arrays)
        $HtmlLines = @(
            "<!DOCTYPE html>",
            "<html lang='en'>",
            "<head>",
            "    <meta charset='UTF-8'>",
            "    <title>$Title</title>",
            "    <link href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css' rel='stylesheet'>",
            "    <style>",
            "        body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; }",
            "        .breadcrumb { background: #e9ecef; padding: 10px 15px; border-radius: 5px; margin-bottom: 20px; }",
            "        .score-high { color: #dc3545; font-weight: bold; }",
            "        .score-med  { color: #fd7e14; font-weight: bold; }",
            "        .score-low  { color: #198754; }",
            "        .source-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #475569; border: 1px solid #cbd5e1; }",
            "        .source-tool  { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }",
            "        .filter-bar { background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }",
            "        #error-overlay { display:none; padding: 20px; background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; margin-top: 20px; }",
            "    </style>",
            "</head>",
            "<body>",
            "    <nav aria-label='breadcrumb'>",
            "        <ol class='breadcrumb'>",
            "            <li class='breadcrumb-item'><a href='$BackLink'>Dashboard</a></li>",
            "            <li class='breadcrumb-item active'>$Breadcrumb</li>",
            "        </ol>",
            "    </nav>",
            "    <div class='d-flex justify-content-between align-items-center mb-3'>",
            "        <h2>$Title <span class='badge bg-secondary'>Detailed Analysis</span></h2>",
            "        <span class='text-muted small'>Latest Activity: $GlobalMaxDate</span>",
            "    </div>",
            "    <div class='row filter-bar align-items-center'>",
            "        <div class='col-md-4'><input type='text' id='searchInput' class='form-control' placeholder='Search item names...' onkeyup='applyFilters()'></div>",
            "        <div class='col-md-3'>",
            "            <select id='rarityFilter' class='form-select' onchange='applyFilters()'>",
            "                <option value='100' selected>Unique Only (100%)</option>",
            "                <option value='90'>High Rarity (>90%)</option>",
            "                <option value='0'>All Rarities</option>",
            "            </select>",
            "        </div>",
            "        <div class='col-md-3'>",
            "            <select id='timeFilter' class='form-select' onchange='applyFilters()'>",
            "                <option value='0' selected>Any Time</option>",
            "                <option value='30'>Last 30 Days</option>",
            "                <option value='90'>Last 90 Days</option>",
            "                <option value='365'>Last Year</option>",
            "            </select>",
            "        </div>",
            "        <div class='col-md-2 text-end text-muted' id='countDisplay'>Showing all</div>",
            "    </div>",
            "    <div id='error-overlay'></div>",
            "    <ul class='nav nav-tabs' id='reportTabs' role='tablist'></ul>",
            "    <div class='tab-content pt-3' id='reportContent'></div>",
            "    <div id='loading' class='text-center text-muted mt-5'><div class='spinner-border text-primary'></div><p>Loading...</p></div>",
            "    <textarea id='data_store' style='display:none;'>$B64Data</textarea>",
            "    <script>",
            "        function fail(msg) { document.getElementById('error-overlay').innerText = msg; document.getElementById('error-overlay').style.display = 'block'; }",
            "        window.applyFilters = function() {",
            "            const search = document.getElementById('searchInput').value.toLowerCase();",
            "            const rarity = parseFloat(document.getElementById('rarityFilter').value);",
            "            const timeLimit = parseInt(document.getElementById('timeFilter').value);",
            "            const activePane = document.querySelector('.tab-pane.active');",
            "            if (!activePane) return;",
            "            const rows = activePane.querySelectorAll('tbody tr');",
            "            let visible = 0; const now = new Date();",
            "            rows.forEach(row => {",
            "                const name = row.getAttribute('data-name').toLowerCase();",
            "                const score = parseFloat(row.getAttribute('data-score'));",
            "                const dateStr = row.getAttribute('data-date');",
            "                let matchesTime = true;",
            "                if (timeLimit > 0) {",
            "                    if (!dateStr || dateStr === 'Unknown' || dateStr === '') { matchesTime = false; }",
            "                    else {",
            "                        const diffDays = Math.ceil(Math.abs(now - new Date(dateStr)) / (1000 * 60 * 60 * 24));",
            "                        if (diffDays > timeLimit) matchesTime = false;",
            "                    }",
            "                }",
            "                if (name.includes(search) && score >= rarity && matchesTime) { row.style.display = ''; visible++; } else { row.style.display = 'none'; }",
            "            });",
            "            document.getElementById('countDisplay').innerText = 'Showing ' + visible + ' items';",
            "        };",
            "        (function() {",
            "            try {",
            "                const rawB64 = document.getElementById('data_store').value;",
            "                if (!rawB64) throw new Error('Data empty.');",
            "                const binaryString = window.atob(rawB64);",
            "                const bytes = new Uint8Array(binaryString.length);",
            "                for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }",
            "                const decoder = new TextDecoder('utf-8');",
            "                const data = JSON.parse(decoder.decode(bytes));",
            "                const tabs = document.getElementById('reportTabs');",
            "                const content = document.getElementById('reportContent');",
            "                document.getElementById('loading').style.display = 'none';",
            "                let isFirst = true; let hasData = false;",
            "                Object.keys(data).forEach((cat, idx) => {",
            "                    const items = Array.isArray(data[cat]) ? data[cat] : [data[cat]];",
            "                    if (!items || items.length === 0 || (items.length === 1 && !items[0].Item_Name)) return;",
            "                    hasData = true;",
            "                    tabs.insertAdjacentHTML('beforeend', '<li class=\'nav-item\'><button class=\'nav-link ' + (isFirst ? 'active' : '') + '\' data-bs-toggle=\'tab\' data-bs-target=\'#pane-' + idx + '\' type=\'button\' onclick=\'setTimeout(applyFilters, 50)\'>' + cat + ' <span class=\'badge bg-secondary ms-1\'>' + items.length + '</span></button></li>');",
            "                    let html = '<div class=\'tab-pane fade ' + (isFirst ? 'show active' : '') + '\' id=\'pane-' + idx + '\'><div class=\'table-responsive\'><table class=\'table table-hover table-striped small\'><thead><tr><th>Item Name</th><th>Last Seen</th><th>Source</th><th>Count</th><th>Rarity</th></tr></thead><tbody>';",
            "                    items.sort((a,b) => (new Date(b.Last_Seen||0) - new Date(a.Last_Seen||0)));",
            "                    items.forEach(row => {",
            "                        let name = (row.Item_Name || row.Rule_Title || 'Unknown').replace(/</g, '&lt;');",
            "                        let score = parseFloat(row.Baseline_Rarity_Score) || 0;",
            "                        let cls = score >= 100 ? 'score-high' : (score >= 90 ? 'score-med' : 'score-low');",
            "                        let srcCls = (row._Source||'').startsWith('Tool:') ? 'source-badge source-tool' : 'source-badge';",
            "                        html += '<tr data-name=\'' + name.toLowerCase() + '\' data-score=\'' + score + '\' data-date=\'' + (row.Last_Seen||'') + '\'>' +",
            "                            '<td class=\'text-break\' style=\'max-width:500px;\'>' + name + '</td>' +",
            "                            '<td style=\'white-space:nowrap;\'>' + (row.Last_Seen||'Unknown') + '</td>' +",
            "                            '<td style=\'width:150px;\'><span class=\'' + srcCls + '\'>' + (row._Source||'Direct') + '</span></td>' +",
            "                            '<td>' + (row.Malicious_Count||0) + '</td>' +",
            "                            '<td class=\'' + cls + '\'>' + score + '%</td></tr>';",
            "                    });",
            "                    content.insertAdjacentHTML('beforeend', html + '</tbody></table></div></div>');",
            "                    isFirst = false;",
            "                });",
            "                if (!hasData) content.innerHTML = '<div class=\'alert alert-info\'>No analysis data found.</div>';",
            "                setTimeout(applyFilters, 100);",
            "            } catch (e) { fail(e.message); }",
            "        })();",
            "    </script>",
            "    <script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js'></script>",
            "</body>",
            "</html>"
        )
        
        $FinalHtml = $HtmlLines -join "`n"
        $FinalHtml | Set-Content -Path $ReportPath -Encoding UTF8
        return [PSCustomObject]@{ Path=$ReportPath; Size=$TotalItems; LastSeen=$GlobalMaxDate }
    }

    # --- 3. MAIN INDEX GENERATOR ---
    $IndexData = @()
    $AptRoot = Join-Path $AbsRoot "APTs"
    if (Test-Path $AptRoot) {
        Get-ChildItem -Path $AptRoot -Directory | ForEach-Object {
            $cntry = $_; Get-ChildItem -Path $cntry.FullName -Directory | ForEach-Object {
                $grp = $_; Write-Host "  Processing APT: $($grp.Name)" -NoNewline
                $Res = Generate-SubReport -TargetFolder $grp.FullName -Title "$($cntry.Name) - $($grp.Name)" -Breadcrumb "$($cntry.Name) / $($grp.Name)" -ActorName $grp.Name -IsAPT $true
                Write-Host " [OK] ($($Res.Size) items)" -ForegroundColor Gray
                $IndexData += [PSCustomObject]@{ Type="APT"; Group=$cntry.Name; Name=$grp.Name; Link=(Get-RelativePath -From $AbsOutput -To $Res.Path); Count=$Res.Size; LastSeen=$Res.LastSeen }
            }
        }
    }
    $MalRoot = Join-Path $AbsRoot "Malware Families"
    if (Test-Path $MalRoot) {
        Get-ChildItem -Path $MalRoot -Directory | ForEach-Object {
            $fam = $_; Write-Host "  Processing Malware: $($fam.Name)" -NoNewline
            $Res = Generate-SubReport -TargetFolder $fam.FullName -Title "Malware: $($fam.Name)" -Breadcrumb "Malware / $($fam.Name)" -ActorName $fam.Name -IsAPT $false
            Write-Host " [OK] ($($Res.Size) items)" -ForegroundColor Gray
            $IndexData += [PSCustomObject]@{ Type="Malware"; Group="Malware Family"; Name=$fam.Name; Link=(Get-RelativePath -From $AbsOutput -To $Res.Path); Count=$Res.Size; LastSeen=$Res.LastSeen }
        }
    }

    # --- 4. MAIN HTML (The Fixed Card View) ---
    Write-Host "  Building Main Index Page..." -ForegroundColor Gray
    
    $IndexJson = $IndexData | ConvertTo-Json -Depth 3 -Compress
    $IndexBytes = [System.Text.Encoding]::UTF8.GetBytes($IndexJson)
    $IndexB64 = [Convert]::ToBase64String($IndexBytes)

    # Replaced Here-Strings with Array to avoid indentation errors
    $MainLines = @(
        "<!DOCTYPE html>",
        "<html lang='en'>",
        "<head>",
        "    <meta charset='UTF-8'>",
        "    <meta name='viewport' content='width=device-width, initial-scale=1.0'>",
        "    <title>$ReportTitle</title>",
        "    <link href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css' rel='stylesheet'>",
        "    <style>",
        "        body { background-color: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; padding: 40px; }",
        "        .card { background-color: #2d2d2d; border: 1px solid #444; margin-bottom: 20px; transition: transform 0.2s; }",
        "        .card:hover { transform: translateY(-5px); border-color: #0d6efd; }",
        "        .card-header { background-color: #252525; border-bottom: 1px solid #444; font-weight: bold; color: #fff; }",
        "        .card-body { color: #ccc; }",
        "        .search-box { background: #333; border: 1px solid #555; color: white; padding: 10px; width: 100%; border-radius: 5px; margin-bottom: 30px; }",
        "        .stat-badge { font-size: 0.8rem; background: #444; padding: 2px 6px; border-radius: 4px; color: #aaa; }",
        "        .date-badge { font-size: 0.8rem; color: #0dcaf0; }",
        "        #error-overlay { display:none; padding: 15px; background: #900; color: white; margin-bottom: 20px; }",
        "    </style>",
        "</head>",
        "<body>",
        "    <div class='container'>",
        "        <h1 class='text-center mb-4'>$ReportTitle</h1>",
        "        <div id='error-overlay'></div>",
        "        <input type='text' id='search' class='search-box' placeholder='Search for Groups or Malware...' onkeyup='filterGrid()'>",
        "        <div id='apt-section' style='display:none;'>",
        "            <h4 class='mt-4 border-bottom pb-2'>Advanced Persistent Threats (APTs)</h4>",
        "            <div class='row' id='apt-grid'></div>",
        "        </div>",
        "        <div id='malware-section' style='display:none;'>",
        "            <h4 class='mt-5 border-bottom pb-2'>Malware Families</h4>",
        "            <div class='row' id='malware-grid'></div>",
        "        </div>",
        "        <div id='empty-msg' class='text-center text-muted mt-5' style='display:none;'>No reports found.</div>",
        "    </div>",
        "    <textarea id='index_store' style='display:none;'>$IndexB64</textarea>",
        "    <script>",
        "        (function() {",
        "            try {",
        "                const rawB64 = document.getElementById('index_store').value;",
        "                if (!rawB64) throw new Error('Index data empty.');",
        "                const binaryString = window.atob(rawB64);",
        "                const bytes = new Uint8Array(binaryString.length);",
        "                for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }",
        "                const decoder = new TextDecoder('utf-8');",
        "                const indexData = JSON.parse(decoder.decode(bytes));",
        "                if (indexData.length === 0) { document.getElementById('empty-msg').style.display = 'block'; return; }",
        "                const aptContainer = document.getElementById('apt-grid');",
        "                const malContainer = document.getElementById('malware-grid');",
        "                let hasApt = false;",
        "                let hasMal = false;",
        "                indexData.sort((a, b) => (a.Group + a.Name).localeCompare(b.Group + b.Name));",
        "                indexData.forEach(item => {",
        "                    const col = document.createElement('div');",
        "                    col.className = 'col-md-3 item-card';",
        "                    col.setAttribute('data-search', (item.Group + ' ' + item.Name).toLowerCase());",
        "                    const dt = item.LastSeen === 'Unknown' ? 'No Data' : item.LastSeen;",
        "                    let html = '<div class=\'card h-100\'>' +",
        "                        '<div class=\'card-header d-flex justify-content-between\'><span>' + item.Group + '</span><span class=\'stat-badge\'>' + item.Count + ' items</span></div>' +",
        "                        '<div class=\'card-body text-center\'>' +",
        "                            '<h5 class=\'card-title\'>' + item.Name + '</h5>' +",
        "                            '<p class=\'mb-3 date-badge\'>Last Seen: ' + dt + '</p>' +",
        "                            '<a href=\'' + item.Link + '\' class=\'btn btn-outline-primary btn-sm stretched-link\'>View Analysis</a>' +",
        "                        '</div></div>';",
        "                    col.innerHTML = html;",
        "                    if(item.Type === 'APT') {",
        "                        aptContainer.appendChild(col);",
        "                        hasApt = true;",
        "                    } else {",
        "                        malContainer.appendChild(col);",
        "                        hasMal = true;",
        "                    }",
        "                });",
        "                if(hasApt) document.getElementById('apt-section').style.display = 'block';",
        "                if(hasMal) document.getElementById('malware-section').style.display = 'block';",
        "            } catch (e) {",
        "                document.getElementById('error-overlay').innerText = 'Dashboard Error: ' + e.message;",
        "                document.getElementById('error-overlay').style.display = 'block';",
        "            }",
        "        })();",
        "        function filterGrid() {",
        "            const term = document.getElementById('search').value.toLowerCase();",
        "            document.querySelectorAll('.item-card').forEach(card => {",
        "                const text = card.getAttribute('data-search');",
        "                card.style.display = text.includes(term) ? 'block' : 'none';",
        "            });",
        "        }",
        "    </script>",
        "</body>",
        "</html>"
    )

    $MainHtml = $MainLines -join "`n"
    $MainHtml | Set-Content -Path $AbsOutput -Encoding UTF8
    Write-Host "Success! Main dashboard: $AbsOutput" -ForegroundColor Green
}